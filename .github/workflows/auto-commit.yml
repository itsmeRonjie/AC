name: Auto Commit

on:
  push:
    branches:
      - master
  schedule:
    - cron: "*/40 * * * *"
  workflow_dispatch:

permissions:
  contents: write

jobs:
  auto_commit:
    runs-on: ubuntu-latest
    env:
      MIN_COMMITS: 1
      MAX_COMMITS: 6
      WAIT_MIN_SECONDS: 5
      WAIT_MAX_SECONDS: 35
      SKIP_PERCENT: 25
      PUSH_MAX_RETRIES: 5
      PUSH_RETRY_DELAY: 8
    steps:
      - name: Show current ref
        run: echo "::debug::Ref = ${{ github.ref }}"

      - name: Check out repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Configure git user
        run: |
          git config user.email "41898282+github-actions[bot]@users.noreply.github.com"
          git config user.name "github-actions[bot]"

      - name: Randomize commits
        run: |
          skip_percent=${SKIP_PERCENT:-20}
          roll=$((RANDOM % 100))
          if [ "$roll" -lt "$skip_percent" ]; then
            echo "Skipping this run randomly (roll ${roll}% under ${skip_percent}%)."
            exit 0
          fi

          min=${MIN_COMMITS:-1}
          max=${MAX_COMMITS:-4}
          if [ "$max" -lt "$min" ]; then
            echo "MAX_COMMITS ($max) must be greater than or equal to MIN_COMMITS ($min)."
            exit 1
          fi

          range=$((max - min + 1))
          count=$((RANDOM % range + min))
          echo "Random commit count for this run: $count"

          wait_min=${WAIT_MIN_SECONDS:-5}
          wait_max=${WAIT_MAX_SECONDS:-30}
          if [ "$wait_max" -lt "$wait_min" ]; then
            wait_max="$wait_min"
          fi

          messages=(
            "chore(bot): updated timestamp â°"
            "chore(bot): keeping things fresh ðŸ”„"
            "chore(bot): keeping the heartbeat going ðŸ’“"
            "chore(bot): routine check-in ðŸ“…"
            "chore(bot): minor update, major vibes âœ¨"
            "chore(bot): automation doing its thing ðŸš€"
            "chore(bot): time update from the bot ðŸ› ï¸"
            "chore(bot): staying alive with updates ðŸŽµ"
            "chore(bot): heartbeat ping ðŸŒ±"
            "chore(bot): another little blip ðŸ’š"
            "chore(bot): random shade unlocked ðŸŒ¿"
          )

          for i in $(seq 1 "$count"); do
            timestamp=$(date -u '+%Y-%m-%dT%H:%M:%SZ')
            random_hex=$(printf "%04x" "$RANDOM")
            echo "${timestamp} :: heartbeat ${i}/${count} token:${random_hex}" > LAST_UPDATED
            git add LAST_UPDATED
            msg_index=$((RANDOM % ${#messages[@]}))
            git commit -m "${messages[$msg_index]}"

            if [ "$i" -lt "$count" ]; then
              sleep_range=$((wait_max - wait_min + 1))
              sleep_seconds=$((RANDOM % sleep_range + wait_min))
              echo "Sleeping ${sleep_seconds}s before the next commit..."
              sleep "$sleep_seconds"
            fi
          done

      - name: Sync and push updates
        env:
          BRANCH_NAME: ${{ github.ref_name }}
        run: |
          branch="${BRANCH_NAME:-master}"
          retries=${PUSH_MAX_RETRIES:-5}
          delay=${PUSH_RETRY_DELAY:-10}
          attempt=1

          while [ "$attempt" -le "$retries" ]; do
            git fetch origin "$branch"

            if git diff --quiet "origin/${branch}" HEAD; then
              echo "No new commits to push."
              exit 0
            fi

            echo "Push attempt ${attempt}/${retries}"
            if git rebase -X ours "origin/${branch}"; then
              if git push origin "HEAD:${branch}"; then
                echo "Push succeeded."
                exit 0
              fi
            else
              echo "Rebase failed; aborting and retrying..."
              git rebase --abort || true
            fi

            if [ "$attempt" -eq "$retries" ]; then
              echo "Push failed on final attempt."
              exit 1
            fi

            echo "Push failed; waiting ${delay}s before retry..."
            sleep "$delay"
            attempt=$((attempt + 1))
          done
