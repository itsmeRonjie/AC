name: Random Auto Commits

on:
  schedule:
    - cron: "7 5 * * *"
    - cron: "37 17 * * *"
  workflow_dispatch:

permissions:
  contents: write

jobs:
  heartbeat:
    runs-on: ubuntu-latest
    env:
      MIN_COMMITS: 0
      MAX_COMMITS: 6
      WAIT_MIN_SECONDS: 5
      WAIT_MAX_SECONDS: 40
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Configure git user
        run: |
          git config user.email "41898282+github-actions[bot]@users.noreply.github.com"
          git config user.name "github-actions[bot]"

      - name: Create random commits
        run: |
          MIN=${MIN_COMMITS:-0}
          MAX=${MAX_COMMITS:-5}
          if [ "$MAX" -lt "$MIN" ]; then
            echo "MAX_COMMITS ($MAX) must be greater than or equal to MIN_COMMITS ($MIN)"
            exit 1
          fi

          RANGE=$((MAX - MIN + 1))
          COUNT=$((RANDOM % RANGE + MIN))
          echo "Random commit count for this run: $COUNT"

          if [ "$COUNT" -le 0 ]; then
            echo "Randomizer skipped commits this run."
            exit 0
          fi

          wait_min=${WAIT_MIN_SECONDS:-5}
          wait_max=${WAIT_MAX_SECONDS:-30}
          if [ "$wait_max" -lt "$wait_min" ]; then
            wait_max="$wait_min"
          fi

          for i in $(seq 1 "$COUNT"); do
            ts=$(date -u +"%Y-%m-%dT%H:%M:%SZ")
            rand=$(printf "%04x" "$RANDOM")
            echo "${ts} commit ${i}/${COUNT} token:${rand}" > LAST_UPDATED
            git add LAST_UPDATED
            git commit -m "chore: random heartbeat ${ts} (${i}/${COUNT})"

            if [ "$i" -lt "$COUNT" ]; then
              sleep_range=$((wait_max - wait_min + 1))
              sleep_seconds=$((RANDOM % sleep_range + wait_min))
              echo "Sleeping ${sleep_seconds}s before the next commit..."
              sleep "$sleep_seconds"
            fi
          done

      - name: Push updates
        env:
          BRANCH_NAME: ${{ github.ref_name }}
        run: |
          branch="${BRANCH_NAME:-master}"
          git push origin "HEAD:${branch}"
